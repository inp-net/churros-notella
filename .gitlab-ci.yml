.buildkit:
  image:
    name: moby/buildkit:rootless
    entrypoint: ["sh", "-c"]
  variables:
    BUILDKITD_FLAGS: --oci-worker-no-process-sandbox
  before_script:
    - |
      mkdir -p ~/.docker && cat > ~/.docker/config.json <<EOF
      {
        "auths": {
          "$CI_REGISTRY": {
            "auth": "$(echo -n "$CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD" | base64)"
          }
        }
      }
      EOF


build:
  extends: .buildkit
  stage: build
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
      variables:
        DEPLOY: "true"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        DEPLOY: "false"
  script:
    - |
      if [ "$DEPLOY" == "true" ]; then
        export TAG=$(echo $CI_COMMIT_TAG | sed 's/^v//')
      else
        export TAG=latest-$(echo $CI_COMMIT_SHA | cut -c-6)
      fi
    - |
      buildctl-daemonless.sh build \
          --frontend=dockerfile.v0 \
          --local context=. \
          --local dockerfile=. \
          --opt build-arg:TAG=$TAG \
          --output type=image,name=$CI_REGISTRY_IMAGE:v$TAG,push=$DEPLOY
    - |
      if [ "$DEPLOY" == "true"]; then 
        echo "Successfully built and pushed $CI_REGISTRY_IMAGE:v$TAG"
      else
        echo "Successfully built $CI_REGISTRY_IMAGE:v$TAG"
      fi
